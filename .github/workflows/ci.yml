name: CI
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      - run: go mod tidy
      - run: go test -v -race -count=1 ./...
      - run: go build -o envlock .
      - name: Smoke test
        run: |
          mkdir -p /tmp/testproject
          echo 'DATABASE_URL=x' > /tmp/testproject/.env
          cat > /tmp/testproject/app.py << 'EOF'
          import os
          db = os.getenv('DATABASE_URL')
          key = os.getenv('MISSING_VAR')
          EOF
          ./envlock --dir /tmp/testproject --json || echo "Expected exit 1 for missing vars"
